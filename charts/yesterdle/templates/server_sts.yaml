apiVersion: v1
kind: Service
metadata:
  labels:
    app: yesterdle-server
  name: yesterdle-service
spec:
  ports:
  - name: yesterdle-server
    port: 8080
    protocol: TCP
    targetPort: 8080
  selector:
    app: yesterdle-server
  type: ClusterIP
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: yesterdle-server
  name: yesterdle-server
spec:
  serviceName: "yesterdle-service"
  replicas: {{ .Values.replicas }}
  selector:
    matchLabels:
      app: yesterdle-server
  template:
    metadata:
      labels:
        app: yesterdle-server
    spec:
      containers:
        - image: criyl/yesterdle:latest
          name: yesterdle-server
          volumeMounts:
            - mountPath: "/opt/project/out"
              name: server-data
          securityContext:
            capabilities:
              add:
                - NET_ADMIN
          ports:
            - containerPort: 8080
          resources:
            limits:
              cpu: '4'
              memory: 2048Mi
            requests:
              cpu: '1'
              memory: 1024Mi
      volumes:
        - name: server-data
          persistentVolumeClaim:
            claimName: {{ .Values.persistence.existingClaim }}